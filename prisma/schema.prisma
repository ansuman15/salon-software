// Prisma schema for SalonX - Salon Management Software
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE TABLES
// ============================================

model Salon {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  city      String?
  currency  String   @default("INR")
  timezone  String   @default("Asia/Kolkata")
  logoUrl   String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  users      User[]
  staff      Staff[]
  customers  Customer[]
  services   Service[]
  settings   Settings?
  auditLogs  AuditLog[]

  @@map("salons")
}

model User {
  id        String   @id @default(uuid())
  salonId   String   @map("salon_id")
  email     String   @unique
  name      String
  role      Role     @default(RECEPTIONIST)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  salon     Salon      @relation(fields: [salonId], references: [id])
  auditLogs AuditLog[]

  @@map("users")
}

enum Role {
  OWNER
  RECEPTIONIST
  STYLIST
}

// ============================================
// STAFF & CUSTOMERS
// ============================================

model Staff {
  id        String   @id @default(uuid())
  salonId   String   @map("salon_id")
  name      String
  phone     String?
  role      String   // Stylist, Therapist, Manager, etc.
  imageUrl  String?  @map("image_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  salon         Salon              @relation(fields: [salonId], references: [id])
  services      StaffService[]
  appointments  Appointment[]
  workingHours  StaffWorkingHours[]

  @@map("staff")
}

model StaffWorkingHours {
  id        String @id @default(uuid())
  staffId   String @map("staff_id")
  dayOfWeek Int    @map("day_of_week") // 0=Sunday, 1=Monday, etc.
  startTime String @map("start_time") // "09:00"
  endTime   String @map("end_time")   // "18:00"
  isOff     Boolean @default(false) @map("is_off")

  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, dayOfWeek])
  @@map("staff_working_hours")
}

model Customer {
  id        String   @id @default(uuid())
  salonId   String   @map("salon_id")
  name      String
  phone     String   // Primary identifier
  email     String?
  gender    String?
  notes     String?
  tags      String[] @default([]) // VIP, Regular, New
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  salon        Salon                @relation(fields: [salonId], references: [id])
  preferences  CustomerPreference[]
  appointments Appointment[]
  bills        Bill[]
  whatsappLogs WhatsappLog[]

  @@unique([salonId, phone])
  @@map("customers")
}

model CustomerPreference {
  id              String @id @default(uuid())
  customerId      String @map("customer_id")
  preferenceKey   String @map("preference_key")  // hair_type, skin_type, favorite_stylist
  preferenceValue String @map("preference_value")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, preferenceKey])
  @@map("customer_preferences")
}

// ============================================
// SERVICES
// ============================================

model Service {
  id              String  @id @default(uuid())
  salonId         String  @map("salon_id")
  name            String
  category        String  // Hair, Skin, Bridal, Spa, etc.
  durationMinutes Int     @map("duration_minutes")
  price           Decimal @db.Decimal(10, 2)
  description     String?
  isActive        Boolean @default(true) @map("is_active")

  // Relations
  salon               Salon                @relation(fields: [salonId], references: [id])
  staffServices       StaffService[]
  appointmentServices AppointmentService[]

  @@map("services")
}

model StaffService {
  staffId   String @map("staff_id")
  serviceId String @map("service_id")

  staff   Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([staffId, serviceId])
  @@map("staff_services")
}

// ============================================
// APPOINTMENTS - HEART OF THE SYSTEM
// ============================================

model Appointment {
  id              String            @id @default(uuid())
  salonId         String            @map("salon_id")
  customerId      String            @map("customer_id")
  staffId         String            @map("staff_id")
  appointmentDate DateTime          @map("appointment_date") @db.Date
  startTime       String            @map("start_time") // "10:30"
  endTime         String            @map("end_time")   // "11:30"
  status          AppointmentStatus @default(CONFIRMED)
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at")

  // Relations
  customer Customer             @relation(fields: [customerId], references: [id])
  staff    Staff                @relation(fields: [staffId], references: [id])
  services AppointmentService[]
  bill     Bill?

  @@map("appointments")
}

enum AppointmentStatus {
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model AppointmentService {
  id            String  @id @default(uuid())
  appointmentId String  @map("appointment_id")
  serviceId     String  @map("service_id")
  price         Decimal @db.Decimal(10, 2) // Price at time of booking

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id])

  @@map("appointment_services")
}

// ============================================
// BILLING & PAYMENTS
// ============================================

model Bill {
  id            String        @id @default(uuid())
  appointmentId String        @unique @map("appointment_id")
  customerId    String        @map("customer_id")
  totalAmount   Decimal       @map("total_amount") @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  taxAmount     Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  finalAmount   Decimal       @map("final_amount") @db.Decimal(10, 2)
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod PaymentMethod? @map("payment_method")
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id])
  customer    Customer    @relation(fields: [customerId], references: [id])
  payments    Payment[]

  @@map("bills")
}

enum PaymentStatus {
  PAID
  PENDING
  PARTIAL
}

enum PaymentMethod {
  CASH
  UPI
  CARD
}

model Payment {
  id       String        @id @default(uuid())
  billId   String        @map("bill_id")
  amount   Decimal       @db.Decimal(10, 2)
  method   PaymentMethod
  paidAt   DateTime      @default(now()) @map("paid_at")

  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================
// WHATSAPP INTEGRATION
// ============================================

model WhatsappLog {
  id          String   @id @default(uuid())
  customerId  String   @map("customer_id")
  messageType String   @map("message_type") // booking, reminder, confirmation, receipt
  messageBody String   @map("message_body")
  status      String   @default("sent") // sent, delivered, failed
  sentAt      DateTime @default(now()) @map("sent_at")

  customer Customer @relation(fields: [customerId], references: [id])

  @@map("whatsapp_logs")
}

// ============================================
// SETTINGS & CONFIGURATION
// ============================================

model Settings {
  id            String @id @default(uuid())
  salonId       String @unique @map("salon_id")
  openingTime   String @default("09:00") @map("opening_time")
  closingTime   String @default("21:00") @map("closing_time")
  workingDays   Int[]  @default([1, 2, 3, 4, 5, 6]) @map("working_days") // 0=Sun, 6=Sat
  gstPercentage Decimal @default(0) @map("gst_percentage") @db.Decimal(5, 2)
  invoicePrefix String  @default("INV") @map("invoice_prefix")
  whatsappEnabled Boolean @default(false) @map("whatsapp_enabled")
  whatsappNumber  String? @map("whatsapp_number")

  salon Salon @relation(fields: [salonId], references: [id])

  @@map("settings")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  salonId   String   @map("salon_id")
  userId    String?  @map("user_id")
  action    String   // CREATE, UPDATE, DELETE
  entity    String   // customer, appointment, bill, etc.
  entityId  String   @map("entity_id")
  details   String?  // JSON string with change details
  timestamp DateTime @default(now())

  salon Salon @relation(fields: [salonId], references: [id])
  user  User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
